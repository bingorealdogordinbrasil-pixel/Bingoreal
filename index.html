<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <style>
        /* Adicione este estilo para o saldo brilhar quando mudar */
        .saldo-atualizado { animation: brilho 1.5s; }
        @keyframes brilho {
            0% { color: var(--success); transform: scale(1); }
            50% { color: #fff; transform: scale(1.2); }
            100% { color: var(--success); transform: scale(1); }
        }
    </style>
</head>
<body>

<script>
    const API = "https://bingoreal.onrender.com"; 
    let USER_ID = localStorage.getItem('userId');
    let saldoAtual = 0;

    // 1. FUNÃ‡ÃƒO DE LOGIN / CADASTRO (Cria o ID no seu banco bingo_pi)
    async function verificarAcesso() {
        if (!USER_ID) {
            const nome = prompt("Bem-vindo ao Bingo Real! Digite o seu nome para comeÃ§ar:");
            if (nome) {
                try {
                    const res = await fetch(`${API}/criar-usuario`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            name: nome, 
                            email: nome.replace(/\s/g, '').toLowerCase() + Date.now() + "@bingo.com" 
                        })
                    });
                    const user = await res.json();
                    if (user._id) {
                        localStorage.setItem('userId', user._id);
                        USER_ID = user._id;
                        location.reload();
                    }
                } catch (e) {
                    alert("Erro ao conectar com o servidor. Tente novamente.");
                }
            }
        } else {
            // Se jÃ¡ tem ID, inicia o jogo e a vigia do saldo
            iniciarGrade(); // Sua funÃ§Ã£o que desenha os nÃºmeros de 1 a 50
            atualizarInterface();
            
            // Verifica o saldo a cada 4 segundos (vÃª se o PIX caiu)
            setInterval(atualizarInterface, 4000);
        }
    }

    // 2. ATUALIZAÃ‡ÃƒO DA TELA (Saldo, Nome e Cartelas)
    async function atualizarInterface() {
        if(!USER_ID) return;
        try {
            const resUser = await fetch(`${API}/user-data/${USER_ID}`);
            const user = await resUser.json();

            if (user) {
                const elementoSaldo = document.getElementById('playerSaldoStatus');
                
                // Se o saldo aumentou, faz um efeito visual
                if (user.saldo > saldoAtual && saldoAtual !== 0) {
                    elementoSaldo.classList.add('saldo-atualizado');
                    setTimeout(() => elementoSaldo.classList.remove('saldo-atualizado'), 2000);
                    showToast("ðŸ’° Saldo creditado com sucesso!");
                }
                
                saldoAtual = user.saldo;
                elementoSaldo.innerText = `R$ ${user.saldo.toFixed(2)}`;
                document.getElementById('perfilNome').innerText = `ðŸ‘¤ ${user.name.toUpperCase()}`;
                document.getElementById('userIdDisplay').innerText = USER_ID.substring(0,8) + "...";
            }

            // Aqui vocÃª mantÃ©m a lÃ³gica de atualizar as bolas do bingo e cartelas...
            // (A mesma que vocÃª jÃ¡ tinha no seu cÃ³digo)
        } catch(e) {
            console.log("Erro ao sincronizar dados.");
        }
    }

    // 3. GERAR PIX (Envia o ID correto para o servidor)
    async function confirmarGerarPix() {
        const val = parseFloat(document.getElementById('valorInputManual').value);
        if (!val || val < 10) return alert("O valor mÃ­nimo Ã© R$ 10");

        try {
            // Mostra um aviso de "carregando"
            document.getElementById('modalValor').classList.add('hidden');
            showToast("Gerando QR Code...");

            const res = await fetch(`${API}/gerar-pix`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ 
                    userId: USER_ID, 
                    valor: val,
                    email: "comprador@teste.com" 
                }) 
            });
            
            const data = await res.json();
            if (data.qr_code_base64) {
                document.getElementById('qrImagem').src = `data:image/png;base64,${data.qr_code_base64}`;
                document.getElementById('pixCopiaCola').value = data.qr_code;
                document.getElementById('modalPix').classList.remove('hidden');
            } else {
                alert("Erro ao gerar PIX. Verifique o seu Token do Mercado Pago.");
            }
        } catch (e) {
            alert("Erro de conexÃ£o.");
        }
    }

    // Inicializa tudo ao carregar
    window.onload = verificarAcesso;
</script>
</body>
</html>
