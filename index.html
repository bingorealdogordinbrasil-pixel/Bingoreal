<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bingo Real</title>
    <link rel="stylesheet" href="style.css"> </head>
<body>

<div id="jogoContent">
    <div class="header" style="display:flex; justify-content:space-between; padding:10px; background:#1e293b; border-bottom:2px solid #facc15;">
        <div style="color:#facc15; font-weight:bold;">BINGO REAL</div>
        <button onclick="abrirModalPix()" style="background:#22c55e; color:white; border:none; padding:5px 15px; border-radius:5px; font-weight:bold;">PIX</button>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; background:#0f172a; padding:10px; border-bottom:1px solid #334155;">
        <div><small>TEMPO</small><br><b id="timerTxt">05:00</b></div>
        <div><small>SALDO</small><br><b id="playerSaldoStatus" style="color:#22c55e;">R$ 0,00</b></div>
        <div><small>MEU ID</small><br><b id="userIdDisplay">...</b></div>
    </div>

    </div>

<div id="modalPix" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:999; padding:20px; text-align:center;">
    <div style="background:white; color:black; padding:20px; border-radius:10px; max-width:300px; margin:auto; margin-top:50px;">
        <h3>Depositar via PIX</h3>
        <input type="number" id="valorInput" placeholder="Valor Mínimo R$ 10" style="width:100%; padding:10px; margin-bottom:10px;">
        <button onclick="gerarPix()" style="background:#22c55e; color:white; width:100%; padding:10px; border:none; border-radius:5px; font-weight:bold;">GERAR QR CODE</button>
        <div id="areaQr" style="display:none; margin-top:15px;">
            <img id="qrImg" style="width:200px;">
            <textarea id="copyPaste" readonly style="width:100%; font-size:10px; height:50px; margin-top:10px;"></textarea>
            <button onclick="copyPix()" style="background:#2563eb; color:white; width:100%; padding:10px; border:none; margin-top:5px;">COPIAR CÓDIGO</button>
        </div>
        <button onclick="fecharModal()" style="margin-top:15px; background:none; border:none; color:red;">Fechar</button>
    </div>
</div>

<script>
    const API = "https://bingoreal.onrender.com";
    let USER_ID = localStorage.getItem('userId');

    // 1. FUNÇÃO QUE SAI DA TRAVA (Cria o ID no MongoDB)
    async function inicializar() {
        if (!USER_ID) {
            const nome = prompt("Para começar, digite seu nome de jogador:");
            if (nome) {
                try {
                    const res = await fetch(`${API}/criar-usuario`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            name: nome, 
                            email: nome.replace(/\s/g, '').toLowerCase() + Date.now() + "@teste.com" 
                        })
                    });
                    const user = await res.json();
                    if (user._id) {
                        localStorage.setItem('userId', user._id);
                        USER_ID = user._id;
                        location.reload();
                    }
                } catch (e) { alert("Erro ao conectar com o servidor Render!"); }
            }
        } else {
            document.getElementById('userIdDisplay').innerText = USER_ID.substring(0,8);
            atualizarDados();
            setInterval(atualizarDados, 5000);
        }
    }

    async function atualizarDados() {
        try {
            const res = await fetch(`${API}/user-data/${USER_ID}`);
            const user = await res.json();
            document.getElementById('playerSaldoStatus').innerText = `R$ ${user.saldo.toFixed(2)}`;
        } catch (e) {}
    }

    function abrirModalPix() { document.getElementById('modalPix').style.display = 'block'; }
    function fecharModal() { document.getElementById('modalPix').style.display = 'none'; }

    async function gerarPix() {
        const valor = document.getElementById('valorInput').value;
        if (valor < 10) return alert("Mínimo R$ 10");

        try {
            const res = await fetch(`${API}/gerar-pix`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ userId: USER_ID, valor: valor })
            });
            const data = await res.json();
            if (data.qr_code_base64) {
                document.getElementById('areaQr').style.display = 'block';
                document.getElementById('qrImg').src = `data:image/png;base64,${data.qr_code_base64}`;
                document.getElementById('copyPaste').value = data.qr_code;
            }
        } catch (e) { alert("Erro ao gerar PIX!"); }
    }

    function copyPix() {
        const cp = document.getElementById('copyPaste');
        cp.select();
        document.execCommand('copy');
        alert("Código copiado!");
    }

    window.onload = inicializar;
</script>
</body>
</html>
